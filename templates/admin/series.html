{% extends 'base.html' %}
{% block content %}
<h4>Series</h4>

<!-- Plant Assignment Form -->
{% if plant %}
<div class="alert alert-info mb-4">
  <h5>Asignar Serie al Plantel: {{ plant.name }} ({{ plant.cct }})</h5>
  <form method="post" class="row g-3">
    <input type="hidden" name="assign_series" value="1">
    <div class="col-md-4">
      <label class="form-label">Serie</label>
      <select name="series_id" class="form-select" required>
        <option value="">Seleccionar serie...</option>
        {% for r in rows %}
        <option value="{{ r.id }}">{{ r.name }} ({{ "{:,}".format(r.calculated_remaining) }} disponibles)</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Cantidad de folios</label>
      <input type="number" name="qty" class="form-control" min="1" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">&nbsp;</label>
      <div class="d-grid">
        <button type="submit" class="btn btn-success">Asignar Serie</button>
      </div>
    </div>
    <div class="col-md-2">
      <label class="form-label">&nbsp;</label>
      <div class="d-grid">
        <a href="{{ url_for(return_to) }}" class="btn btn-outline-secondary">Cancelar</a>
      </div>
    </div>
  </form>
</div>
{% endif %}

{% if not plant %}
<div class="row g-3 mb-4">
  <div class="col-md-5">
    <div class="card"><div class="card-body">
      <h6>Agregar Serie</h6>
      <form method="post" class="row g-2">
        <div class="col-8"><input name="name" class="form-control" placeholder="Nombre de la serie" required></div>
        <div class="col-4"><button class="btn btn-primary w-100" type="submit">Agregar</button></div>
      </form>
    </div></div>
  </div>
</div>
{% endif %}
<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Total</th>
      <th>Restantes</th>
      <th>Siguiente</th>
      <th>Folio inicial</th>
      <th>Folio final</th>
      <th>Editar</th>
      <th>Detalle</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
    <tr>
      <td>{{ r.name }}</td>
      <td contenteditable="true" data-series-id="{{ r.id }}" data-field="total" class="editable-cell">{{ r.total_added }}</td>
      <td>{{ "{:,}".format(r.calculated_remaining) }}</td>
      <td>{{ r.next_folio }}</td>
      <td contenteditable="true" data-series-id="{{ r.id }}" data-field="first_folio" class="editable-cell">{{ r.first_folio or '-' }}</td>
      <td>{{ r.last_folio or '-' }}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary save-btn" onclick="saveSeriesInline('{{ r.id }}')">Guardar</button>
      </td>
      <td><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('series_detail', series_id=r.id) }}">Ver</a></td>
      <td>
        <form method="post" action="{{ url_for('admin_delete_series', series_id=r.id) }}" onsubmit="return confirm('¿Eliminar la serie {{ r.name }} y sus asignaciones? Esta acción no se puede deshacer.');">
          <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="9" class="text-muted">Sin series</td></tr>
    {% endfor %}
  </tbody>
</table>
<style>
.editable-cell {
  background: #fffbe5;
  cursor: text;
  transition: background-color 0.2s;
}
.editable-cell:focus {
  background: #fff3cd;
  outline: 2px solid #ffc107;
}
.save-btn {
  display: none;
}
</style>
<script>
function saveSeriesInline(seriesId) {
  const totalCell = document.querySelector(`[data-series-id="${seriesId}"][data-field="total"]`);
  const firstFolioCell = document.querySelector(`[data-series-id="${seriesId}"][data-field="first_folio"]`);
  if (!totalCell || !firstFolioCell) {
    alert('No se encontraron las celdas para editar');
    return;
  }
  const total = parseInt(totalCell.textContent.trim()) || 0;
  const firstFolio = parseInt(firstFolioCell.textContent.trim()) || 0;
  console.log('Saving series:', seriesId, 'total:', total, 'first_folio:', firstFolio);
  const formData = new FormData();
  formData.append('total', total);
  formData.append('first_folio', firstFolio);
  // Add CSRF token if available
  const csrfToken = document.querySelector('meta[name=csrf-token]');
  if (csrfToken) {
    formData.append('csrf_token', csrfToken.getAttribute('content'));
  }
  fetch(`/admin/series/${seriesId}/inline-update`, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  }).then(response => {
    console.log('Response status:', response.status);
    if (response.ok) {
      response.json().then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error al guardar: ' + (data.error || 'Error desconocido'));
        }
      }).catch(() => {
        location.reload(); // Fallback if not JSON
      });
    } else {
      response.json().then(data => {
        console.error('Error response:', data);
        alert('Error al guardar: ' + (data.error || 'Error desconocido'));
      }).catch(() => {
        alert('Error al guardar');
      });
    }
  }).catch(error => {
    console.error('Fetch error:', error);
    alert('Error de red al guardar');
  });
}
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.editable-cell').forEach(cell => {
    const initialValue = cell.textContent.trim();
    cell.addEventListener('input', () => {
      const row = cell.closest('tr');
      const saveBtn = row.querySelector('.save-btn');
      if (cell.textContent.trim() !== initialValue) {
        saveBtn.style.display = 'inline-block';
      } else {
        // check if any other cell in the row is modified
        const modified = Array.from(row.querySelectorAll('.editable-cell')).some(c => c.textContent.trim() !== c.dataset.original);
        saveBtn.style.display = modified ? 'inline-block' : 'none';
      }
    });
    // store original value
    cell.dataset.original = initialValue;
  });
});
</script>
{% endblock %}
