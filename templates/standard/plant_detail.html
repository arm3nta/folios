{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Plantel: {{ plant.name }} ({{ plant.cct }})</h4>
  <div>
    <a href="{{ url_for('plant_detail', plant_id=plant.id, _t=timestamp or int(time.time())) }}" class="btn btn-sm btn-outline-secondary">
      ðŸ”„ Refrescar
    </a>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="row">
      <div class="col-md-8">
        <h5 class="card-title">Asignar Folio</h5>
        <div class="mb-2">
          <small class="text-muted">
            Total del Plantel: <strong>{{ "{:,}".format(plant.qty_total or 0) }}</strong> folios | 
            Asignados: <strong>{{ "{:,}".format(assigned_total or 0) }}</strong> folios
          </small>
        </div>
        {% if assigns %}
        <div class="mb-2">
          <small class="text-info">
            Rangos de folios asignados:
            {% for assign in assigns %}
              <div><strong>{{ "{:,}".format(assign.start_folio) }}</strong> - <strong>{{ "{:,}".format(assign.end_folio) }}</strong></div>
            {% endfor %}
          </small>
        </div>
        {% endif %}
      </div>
      <div class="col-md-4">
        {% if (calculated_remaining or 0) > 0 %}
        <div class="alert alert-success py-2 mb-0">
          <small>âœ… Hay {{ calculated_remaining or 0 }} folios disponibles</small>
        </div>
        {% endif %}
      </div>
    </div>
    
    <form method="post" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Cantidad de folios</label>
        <input name="qty" type="number" min="1" max="{{ calculated_remaining or 0 }}" class="form-control" required>
      </div>
      <div class="col-md-2 align-self-end">
        <button class="btn btn-success w-100" type="submit" {% if not series or (calculated_remaining or 0) <= 0 %}disabled{% endif %}>ASIGNAR</button>
      </div>
    </form>
  </div>
</div>
{% if assigns %}
<h5>Historial de asignaciones</h5>
<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th><a href="{{ url_for('plant_detail', plant_id=plant.id, sort='serie', dir='asc' if not (sort_key == 'serie' and sort_dir == 'asc') else 'desc') }}" class="text-decoration-none">Serie {% if sort_key == 'serie' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
      <th><a href="{{ url_for('plant_detail', plant_id=plant.id, sort='cantidad', dir='asc' if not (sort_key == 'cantidad' and sort_dir == 'asc') else 'desc') }}" class="text-decoration-none">Cantidad {% if sort_key == 'cantidad' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
      <th><a href="{{ url_for('plant_detail', plant_id=plant.id, sort='folio_inicial', dir='asc' if not (sort_key == 'folio_inicial' and sort_dir == 'asc') else 'desc') }}" class="text-decoration-none">Folio inicial {% if sort_key == 'folio_inicial' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
      <th><a href="{{ url_for('plant_detail', plant_id=plant.id, sort='folio_final', dir='asc' if not (sort_key == 'folio_final' and sort_dir == 'asc') else 'desc') }}" class="text-decoration-none">Folio final {% if sort_key == 'folio_final' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
      <th><a href="{{ url_for('plant_detail', plant_id=plant.id, sort='fecha', dir='asc' if not (sort_key == 'fecha' and sort_dir == 'asc') else 'desc') }}" class="text-decoration-none">Fecha {% if sort_key == 'fecha' %}{% if sort_dir == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}</a></th>
    </tr>
  </thead>
  <tbody>
    {% for a in assigns %}
    <tr>
      <td>{{ a.series_name }}</td>
      <td>
        {% if session.get('role') == 'admin' %}
        <span class="editable-qty" data-assignment-id="{{ a.id }}" data-current-qty="{{ a.qty }}">{{ "{:,}".format(a.qty) }}</span>
        {% else %}
        {{ "{:,}".format(a.qty) }}
        {% endif %}
      </td>
      <td>{{ "{:,}".format(a.start_folio) }}</td>
      <td>{{ "{:,}".format(a.end_folio) }}</td>
      <td>{{ format_date(a.assigned_at) }}</td>
    </tr>
    {% else %}
    <tr><td colspan="5" class="text-muted">Sin asignaciones</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
<a class="btn btn-secondary" href="{{ url_for('standard_search') }}">Inicio</a>

{% if session.get('role') == 'admin' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Make quantity cells editable for admin
    const editableCells = document.querySelectorAll('.editable-qty');
    
    editableCells.forEach(cell => {
        cell.style.cursor = 'pointer';
        cell.style.backgroundColor = '#f8f9fa';
        cell.style.padding = '4px 8px';
        cell.style.borderRadius = '4px';
        cell.style.border = '1px solid #dee2e6';
        
        cell.addEventListener('click', function() {
            const currentValue = this.getAttribute('data-current-qty');
            const assignmentId = this.getAttribute('data-assignment-id');
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.className = 'form-control form-control-sm';
            input.style.width = '100px';
            
            // Replace cell content with input
            this.innerHTML = '';
            this.appendChild(input);
            input.focus();
            input.select();
            
            // Handle save
            const saveEdit = () => {
                const newValue = parseInt(input.value);
                
                if (isNaN(newValue) || newValue < 0) {
                    alert('La cantidad debe ser un nÃºmero positivo');
                    this.textContent = currentValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    return;
                }
                
                // Save to server
                fetch(`/admin/assignments/${assignmentId}/update-qty`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        qty: newValue
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update cell with new value
                        this.setAttribute('data-current-qty', newValue);
                        this.textContent = newValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        
                        // Show success message
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-sm mt-2';
                        alert.textContent = 'Cantidad actualizada correctamente';
                        this.parentElement.appendChild(alert);
                        
                        // Remove alert after 3 seconds
                        setTimeout(() => alert.remove(), 3000);
                        
                        // Refresh page after 2 seconds to show updated folios
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        alert('Error: ' + data.error);
                        this.textContent = currentValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al actualizar la cantidad');
                    this.textContent = currentValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                });
            };
            
            // Save on Enter key
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                }
            });
            
            // Save on blur (click outside)
            input.addEventListener('blur', saveEdit);
        });
    });
});
</script>
{% endif %}

{% endblock %}
