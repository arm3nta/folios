{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>Serie: {{ series.name }}</h4>
  <div>
    {% if session.get('role') == 'admin' %}
    <form method="post" action="{{ url_for('admin_cleanup_zero_assignments') }}" style="display: inline;">
      <button type="submit" class="btn btn-sm btn-danger me-2" onclick="return confirm('Â¿Eliminar asignaciones con cantidad cero? Esto limpiarÃ¡ datos inconsistentes.')">
        ðŸ§¹ Limpiar Ceros
      </button>
    </form>
    <form method="post" action="{{ url_for('admin_recalculate_series', series_id=series.id) }}" style="display: inline;">
      <button type="submit" class="btn btn-sm btn-warning me-2" onclick="return confirm('Â¿Recalcular totales de esta serie? Esto corregirÃ¡ los valores basados en las asignaciones reales.')">
        ðŸ”„ Recalcular
      </button>
    </form>
    {% endif %}
    <a href="{{ url_for('series_detail', series_id=series.id, _t=timestamp) }}" class="btn btn-sm btn-outline-secondary">
      ðŸ”„ Refrescar
    </a>
  </div>
</div>
<div class="row mb-3">
  {% if request.args.get('plant_id') %}
  <div class="col-md-12">
    <div class="alert alert-info">
      <strong>Vista filtrada por plantel especÃ­fico: {{ plant_data.name if plant_data else 'Desconocido' }}</strong>
      <div class="row mt-2">
        <div class="col-md-3"><div class="border p-2">Total del Plantel: <strong>{{ "{:,}".format(plant_data.qty_total or 0) }}</strong></div></div>
        <div class="col-md-3"><div class="border p-2">Asignados al Plantel: <strong>{{ "{:,}".format(assigned_docs) }}</strong></div></div>
        <div class="col-md-3"><div class="border p-2">Restantes del Plantel: <strong>{{ "{:,}".format((plant_data.qty_total or 0) - assigned_docs) }}</strong></div></div>
        <div class="col-md-3"><div class="border p-2">Rango del Plantel: <strong>{{ "{:,}".format(plant_folio_start or 0) }} - {{ "{:,}".format(plant_folio_end or 0) }}</strong></div></div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-md-3"><div class="border p-2">Total agregado: <strong>{{ "{:,}".format(series.total_added) }}</strong></div></div>
  <div class="col-md-3"><div class="border p-2">Restantes: <strong>{{ "{:,}".format(series.total_added - assigned_docs) }}</strong></div></div>
  <div class="col-md-3"><div class="border p-2">Folios Asignados: <strong>{{ "{:,}".format(assigned_docs) }}</strong></div></div>
  <div class="col-md-3"><div class="border p-2">Siguiente folio: <strong>{{ "{:,}".format(series.next_folio) }}</strong></div></div>
  {% endif %}
</div>
<h5>Asignaciones</h5>
<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>
        {% set next_dir = 'asc' if sort_key!='plantel' or sort_dir=='desc' else 'desc' %}
        <a href="{{ url_for('series_detail', series_id=series.id, sort='plantel', dir=next_dir, _t=timestamp) }}">Plantel
          {% if sort_key=='plantel' %}{{ 'â†‘' if sort_dir=='asc' else 'â†“' }}{% endif %}
        </a>
      </th>
      <th>
        {% set next_dir = 'asc' if sort_key!='cct' or sort_dir=='desc' else 'desc' %}
        <a href="{{ url_for('series_detail', series_id=series.id, sort='cct', dir=next_dir, _t=timestamp) }}">CCT
          {% if sort_key=='cct' %}{{ 'â†‘' if sort_dir=='asc' else 'â†“' }}{% endif %}
        </a>
      </th>
      <th>
        {% set next_dir = 'asc' if sort_key!='cantidad' or sort_dir=='desc' else 'desc' %}
        <a href="{{ url_for('series_detail', series_id=series.id, sort='cantidad', dir=next_dir, _t=timestamp) }}">Cantidad
          {% if sort_key=='cantidad' %}{{ 'â†‘' if sort_dir=='asc' else 'â†“' }}{% endif %}
        </a>
      </th>
      <th>
        {% set next_dir = 'asc' if sort_key!='folio_inicial' or sort_dir=='desc' else 'desc' %}
        <a href="{{ url_for('series_detail', series_id=series.id, sort='folio_inicial', dir=next_dir, _t=timestamp) }}">Folio inicial
          {% if sort_key=='folio_inicial' %}{{ 'â†‘' if sort_dir=='asc' else 'â†“' }}{% endif %}
        </a>
      </th>
      <th>
        {% set next_dir = 'asc' if sort_key!='folio_final' or sort_dir=='desc' else 'desc' %}
        <a href="{{ url_for('series_detail', series_id=series.id, sort='folio_final', dir=next_dir, _t=timestamp) }}">Folio final
          {% if sort_key=='folio_final' %}{{ 'â†‘' if sort_dir=='asc' else 'â†“' }}{% endif %}
        </a>
      </th>
      <th>
        {% set next_dir = 'asc' if sort_key!='fecha' or sort_dir=='desc' else 'desc' %}
        <a href="{{ url_for('series_detail', series_id=series.id, sort='fecha', dir=next_dir, _t=timestamp) }}">Fecha
          {% if sort_key=='fecha' %}{{ 'â†‘' if sort_dir=='asc' else 'â†“' }}{% endif %}
        </a>
      </th>
    </tr>
  </thead>
  <tbody>
    {% for a in assigns %}
    <tr>
      <td>{{ a.plant_name }}</td>
      <td>{{ a.plant_cct }}</td>
      <td>{{ a.qty }}</td>
      <td>{{ a.start_folio }}</td>
      <td>{{ a.end_folio }}</td>
      <td>{{ format_date(a.assigned_at) }}</td>
    </tr>
    {% else %}
    <tr><td colspan="6" class="text-muted">Sin asignaciones</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
